<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>使用 Travis-CI 自动化部署 GitHub Pages</title>
<meta name="keywords" content="珊瑚礁上的程序员, 持续集成, 持续发布, 自动部署, Travis-CI, GitHub Pages" />
<meta name="generator" content="Org Mode" />
<link rel="icon" href="https://demokn.github.io/blog/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://demokn.github.io/blog/assets/lib/twitter-bootstrap/4.4.1/bootstrap.min.css">
<link rel="stylesheet" href="https://demokn.github.io/blog/assets/lib/font-awesome/5.12.1/all.min.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=ZCOOL+KuaiLe|Amaranth|Handlee|Libre+Baskerville|Bree+Serif|Ubuntu+Mono|Pacifico&subset=latin,greek"/>
<link rel="stylesheet" href="https://demokn.github.io/blog/assets/css/site.css">
<link rel="stylesheet" href="https://demokn.github.io/blog/assets/css/highlight.css">
</head>
<body>
<div class="content-wrapper container">
<div class="row">
<div class="col-lg-8 col-md-10 mx-auto">

<div id="preamble" class="status">
<div class="banner">
  <a href="/" style="font-family: 'ZCOOL KuaiLe', cursive;"> 珊瑚礁上的程序员 </a>
</div>
<ul class="banner-links">
  <li><a href="https://demokn.github.io/blog/posts/archive.html"> Archive </a></li>
  <li><a href="https://demokn.github.io/blog/posts/rss.xml"> RSS </a></li>
  <li><a href="https://demokn.github.io/blog/about.html"> About </a></li>
</ul>
<hr>
</div>
<div id="article" class="content">
<header>
<h1 class="title">使用 Travis-CI 自动化部署 GitHub Pages</h1>
<p class="subtitle" role="doc-subtitle">发布于 2019-10-11</p>
</header><div class="alert alert-warning info" id="org36b14c7">
<p>
更新于 2021-11-06
<code>Travis CI</code> 改变了收费策略, 切换到 <code>Github Actions</code>
</p>

</div>

<p>
一直听闻 <code>持续集成</code> 的大名, 这次借着在 <code>GitHub Pages</code> 部署博客来体验一下。
目前已实现当推送一个新的 <code>commit</code> 到 <a href="https://github.com/demokn/blog">我的GitHub仓库</a> <code>master</code> 分支, <a href="https://travis-ci.org/">Travis-CI</a> 就会自动执行构建,
并在构建完成后将生成的 HTML 等内容发布到 <code>gh-pages</code> 分支。
</p>

<p>
大致流程如下:
</p>


<figure id="org4d4f214">
<img src="./github-travis-flow.png" alt="github-travis-flow.png" class="mx-auto d-block mw-100">

</figure>

<p>
所谓借助 <code>Travis-CI</code> 自动构建，无非就是把原本需要自己手动执行的命令或脚本，
通过 <code>.travis.yml</code> 配置文件告诉 <code>Travis-CI</code> 该如何一步步执行。
</p>

<section id="outline-container-org26fcb3b" class="outline-2">
<h2 id="org26fcb3b">博客仓库</h2>
<div class="outline-text-2" id="text-org26fcb3b">
<p>
我是用 <code>Emacs Org-mode</code> 来写博客的，源码在 <a href="https://github.com/demokn/blog">demokn/blog</a> 的 <code>master</code> 分支。
自己手动执行构建也非常简单，因为借助了 <code>Makefile</code>, 只需要执行一下 <code>make</code> 命令即可完成构建。
当然还有个前提就是我已经安装了新版的 Emacs.
这里借助 <code>Makefile</code> 并不是使用 <code>Travis-CI</code> 必须的, 我只是提一下本项目手动构建的步骤, 为下面配置 <code>.travis.yml</code> 做准备。
我们也可以把构建所需执行的命令写成一个或多个 <code>shell 脚本</code>, 如本例中的 <code>build.sh</code>.
甚至也可以把这些命令直接逐条写在 <code>.travis.yml</code> 配置文件中（当然不推荐就是了）。
</p>

<p>
再说明一下， <code>GitHub Pages</code> 是有 <a href="https://help.github.com/en/articles/about-github-pages#types-of-github-pages-sites">三种类型</a> 的，分别是 project, user, 和 organization.
最常见到的 <code>&lt;username&gt;/&lt;username&gt;.github.io</code> 仓库, 属于 user 或 organization 类型。
而我用的是 <code>project pages</code>, 所以仓库名可以随便起, 主要有两个分支:
</p>

<ul class="org-ul">
<li>master: 项目源码, 包含构建脚本, Makefile, .travis.yml, org 格式文章等</li>
<li>gh-pages: 构建完成后的 HTML 等文件, 也即是 project pages 通过 <code>https://&lt;user&gt;.github.io/&lt;project&gt;</code> 访问时的默认分支</li>
</ul>
</div>
</section>

<section id="outline-container-org20b84b8" class="outline-2">
<h2 id="org20b84b8">Travis-CI 配置</h2>
<div class="outline-text-2" id="text-org20b84b8">
<p>
因为我也是第一次接触 <code>Travis-CI</code>, 只是经常有在开源库中看到过 <code>.travis.yml</code> 文件。
无疑，这个就是 <code>Travis-CI</code> 的配置文件了，告诉 <code>Travis-CI</code> 当仓库有新的提交时需要做什么事情。
</p>

<p>
至于配置文件该怎么用，格式怎么写，内容怎么配，呵呵，谁还没有过第一次嘛，干就完了。
这里也记录下面对一个对自己来说全新的工具/知识点, 我是怎么学习的, 仅供参考：
</p>

<ol class="org-ol">
<li>先找 2-3 篇 <code>中文教程</code> 简单过一下，对 <code>Travis-CI</code> 有个入门级的了解, 是什么, 能做什么, 怎么做；（谁让咱英语不行呢）</li>
<li>打开官网, 随便看看, 随便点点, 然后, <code>看官方文档</code>, <code>看官方文档</code>, <code>看官方文档</code>, 当然不用一次看完, 拣本次需要用到的知识点看；</li>
<li><p>
开始实践, 同步 GitHub 仓库, 配置 Token, 写 <code>.travis.yml</code> 配置文件, 然后尝试构建。
</p>

<p>
我就直接呈上 <code>.travis.yml</code> 配置文件内容了, 在注释里进行必要的解释。
</p>

<p>
PS: 注释加的有点多, 配置文件显得有点冗长, 别害怕, 其实真的很简单的, 不带注释的参考源文件 <a href="https://github.com/demokn/blog/blob/master/.travis.yml">.travis.yml</a>.
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span class="org-comment-delimiter"># </span><span class="org-comment">Travis-CI &#25903;&#25345;&#24456;&#22810;&#32534;&#31243;&#35821;&#35328;, &#20294;&#27704;&#36828;&#19981;&#21487;&#33021;&#25903;&#25345;&#20840;&#37096;.</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#23601;&#20687;&#26412;&#39033;&#30446;&#24182;&#19981;&#26159;&#20381;&#36182;&#26576;&#31181;&#29305;&#23450;&#30340;&#35821;&#35328;, &#32780;&#26159;&#22522;&#20110; Emacs &#30340; Org-mode, &#36825;&#20063;&#23601;&#35201;&#27714;&#25105;&#20204;&#35201;&#33258;&#24049;&#23433;&#35013;&#20381;&#36182;.</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">language: minimal &#21644; language: generic &#21482;&#26159;&#22522;&#20110; Ubuntu &#30340;&#22522;&#30784;&#38236;&#20687;, &#26410;&#23545;&#20219;&#20309;&#32534;&#31243;&#35821;&#35328;&#20570;&#29305;&#27530;&#30340;&#23450;&#21046;&#21644;&#20248;&#21270;.</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#35814;&#24773;&#21487;&#21442;&#35265;: https://docs.travis-ci.com/user/languages/minimal-and-generic/</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">&#25509;&#19979;&#26469;&#65292;&#25105;&#20204;&#23601;&#35201;&#22312;&#27492;&#22522;&#30784;&#19978;&#33258;&#34892;&#23433;&#35013;&#20381;&#36182;&#20102;</span>
<span class="org-variable-name">languages</span>: minimal

<span class="org-variable-name">git</span>:
  <span class="org-comment-delimiter"># </span><span class="org-comment">&#25351;&#23450; git clone --depth=1, &#40664;&#35748;&#26159; 50</span>
  <span class="org-comment-delimiter"># </span><span class="org-comment">&#35814;&#24773;&#21442;&#35265;: https://docs.travis-ci.com/user/customizing-the-build/#git-clone-depth</span>
  <span class="org-variable-name">depth</span>: 1

  <span class="org-variable-name">branches</span>:
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#25351;&#23450;&#20165;&#24403; master &#20998;&#25903;&#19978;&#26377;&#26032;&#30340;&#25552;&#20132;&#26102;&#25165;&#25191;&#34892;&#26500;&#24314;</span>
    <span class="org-variable-name">only</span>:
      - master

      <span class="org-comment-delimiter"># </span><span class="org-comment">&#33258;&#34892;&#23433;&#35013;&#20381;&#36182;, &#20854;&#23454;&#23601;&#26159;&#22312; Ubuntu &#19978;&#35013;&#20010;&#26032;&#29256; Emacs &#21644; make &#24037;&#20855;</span>
      <span class="org-comment-delimiter"># </span><span class="org-comment">&#22914;&#26524;&#20381;&#36182;&#23433;&#35013;&#22833;&#36133;, &#26500;&#24314;&#36807;&#31243;&#20063;&#20250;&#31435;&#21363;&#20013;&#26029;</span>
      <span class="org-comment-delimiter"># </span><span class="org-comment">&#35814;&#24773;&#21442;&#35265;: https://docs.travis-ci.com/user/customizing-the-build/#installing-a-second-programming-language</span>
      <span class="org-comment-delimiter"># </span><span class="org-comment">&#35814;&#24773;&#21442;&#35265;: https://docs.travis-ci.com/user/job-lifecycle#the-job-lifecycle</span>
      <span class="org-variable-name">before_install</span>:
<span class="org-yaml-tab">        </span>- sudo add-apt-repository -y ppa:kelleyk/emacs
<span class="org-yaml-tab">        </span>- sudo apt-get update -q
<span class="org-yaml-tab">        </span>- sudo apt-get install -y emacs27
<span class="org-yaml-tab">        </span>- sudo apt-get install -y make
<span class="org-yaml-tab">        </span>- sudo apt-get install -y default-jre graphviz

<span class="org-yaml-tab">        </span><span class="org-comment-delimiter"># </span><span class="org-comment">&#36339;&#36807; Travis-CI &#38024;&#23545;&#29305;&#23450;&#30340;&#35821;&#35328;&#33258;&#21160;&#23433;&#35013;&#20381;&#36182;</span>
<span class="org-yaml-tab">        </span><span class="org-comment-delimiter"># </span><span class="org-comment">&#22240;&#20026;&#26412;&#39033;&#30446;&#19981;&#20381;&#36182;&#20110;&#20219;&#20309;&#29305;&#23450;&#30340;&#35821;&#35328;, &#20381;&#36182;&#39033;&#25105;&#20204;&#33258;&#24049;&#23433;&#35013;&#20102;, &#25152;&#20197;&#36825;&#37324;&#36339;&#36807;&#20197;&#33410;&#30465;&#26500;&#24314;&#26102;&#38388;</span>
<span class="org-yaml-tab">        </span><span class="org-comment-delimiter"># </span><span class="org-comment">&#35814;&#24773;&#21442;&#35265;: https://docs.travis-ci.com/user/job-lifecycle#customizing-the-installation-phase</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">install</span>: skip

<span class="org-yaml-tab">        </span><span class="org-comment-delimiter"># </span><span class="org-comment">&#27491;&#24335;&#24320;&#22987;&#25191;&#34892;&#39033;&#30446;&#26500;&#24314;, &#19978;&#38754;&#24050;&#32463;&#20171;&#32461;&#36807;&#20102;, &#26412;&#39033;&#30446;&#21482;&#38656;&#31616;&#21333;&#30340;&#25191;&#34892;&#19968;&#20010; make &#21629;&#20196;&#21363;&#21487;</span>
<span class="org-yaml-tab">        </span><span class="org-comment-delimiter"># </span><span class="org-comment">&#35814;&#24773;&#21442;&#35265;: https://docs.travis-ci.com/user/job-lifecycle#customizing-the-build-phase</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">script</span>: make

<span class="org-yaml-tab">        </span><span class="org-comment-delimiter"># </span><span class="org-comment">&#26500;&#24314;&#23436;&#25104;&#21518;&#33258;&#21160;&#37096;&#32626;&#39033;&#30446;</span>
<span class="org-yaml-tab">        </span><span class="org-comment-delimiter"># </span><span class="org-comment">&#21516;&#26679; Travis-CI &#25903;&#25345;&#37096;&#32626;&#21040;&#30340;&#24179;&#21488;&#26377;&#24456;&#22810;, &#26412;&#39033;&#30446;&#21482;&#38656;&#37096;&#32626;&#21040; GitHub Pages</span>
<span class="org-yaml-tab">        </span><span class="org-comment-delimiter"># </span><span class="org-comment">&#35814;&#24773;&#21442;&#35265;: https://docs.travis-ci.com/user/deployment/</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">deploy</span>:
<span class="org-yaml-tab">        </span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#25351;&#23450;&#37096;&#32626;&#21040; GitHub Pages</span>
<span class="org-yaml-tab">        </span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#35814;&#24773;&#21442;&#35265;: https://docs.travis-ci.com/user/deployment/pages/</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">  provider</span>: pages
<span class="org-yaml-tab">        </span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#22914;&#26524;&#35774;&#20026;false, Travis-CI &#20250;&#21024;&#38500;&#26500;&#24314;&#36807;&#31243;&#20013;&#29983;&#25104;&#30340;&#25152;&#26377;&#25991;&#20214;.</span>
<span class="org-yaml-tab">        </span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#25105;&#20204;&#30340;&#30446;&#30340;&#23601;&#26159;&#25226;&#29983;&#25104;&#30340;HTML&#25991;&#20214;&#19978;&#20256;&#21040; GitHub Pages, &#25152;&#20197;&#32943;&#23450;&#26159;&#19981;&#24076;&#26395;&#34987;&#21024;&#38500;&#30340;.</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">  skip_cleanup</span>: <span class="org-constant">true</span>
<span class="org-yaml-tab">        </span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#37197;&#32622;&#35775;&#38382; GitHub &#30340; Token</span>
<span class="org-yaml-tab">        </span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#35201;&#24819; Travis-CI &#21521; GitHub &#20179;&#24211;&#25552;&#20132;&#20869;&#23481;, &#23601;&#38656;&#35201;&#37197;&#32622;&#19968;&#20010; GitHub &#30340; personal access token</span>
<span class="org-yaml-tab">        </span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#27880;&#24847; Token &#26159;&#32477;&#23545;&#31169;&#23494;&#30340;&#19996;&#35199;, &#19968;&#23450;&#35201;&#27880;&#24847;&#20445;&#23494;, &#21315;&#19975;&#19981;&#33021;&#30452;&#25509;&#20889;&#27515;&#22312;&#20844;&#24320;&#20179;&#24211;&#20013;</span>
<span class="org-yaml-tab">        </span>  <span class="org-comment-delimiter"># </span><span class="org-comment">$GITHUB_TOKEN &#23601;&#26159;&#36890;&#36807;&#21464;&#37327;&#30340;&#24418;&#24335;&#33719;&#21462;&#22312; Travis-CI &#21518;&#21488;&#37197;&#32622;&#22909;&#30340; Token, &#20197;&#36991;&#20813;&#27844;&#28431;</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">  github_token</span>: $GITHUB_TOKEN
<span class="org-yaml-tab">        </span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#37096;&#32626;&#26102;&#26159;&#21542;&#20445;&#30041;&#25552;&#20132;&#21382;&#21490;&#35760;&#24405;, &#22914;&#26524;&#20026; false, &#21017;&#27599;&#27425;&#37096;&#32626;&#37117;&#20165;&#21253;&#21547;&#24403;&#21069;&#25552;&#20132;, &#20250;&#29992; git push --force &#24378;&#21046;&#35206;&#30422;</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">  keep_history</span>: <span class="org-constant">false</span>
<span class="org-yaml-tab">        </span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#25351;&#23450;&#38656;&#35201;&#25512;&#36865;&#21040; GitHub Pages &#30340;&#25991;&#20214;&#30446;&#24405;, &#40664;&#35748;&#23601;&#26159;&#24403;&#21069;&#39033;&#30446;&#26681;&#30446;&#24405;</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">  local_dir</span>: ./public
<span class="org-yaml-tab">        </span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#25512;&#36865; local_dir &#19979;&#30340;&#25991;&#20214;&#21040; target_branch &#25351;&#23450;&#30340;&#20998;&#25903;</span>
<span class="org-yaml-tab">        </span>  <span class="org-comment-delimiter"># </span><span class="org-comment">&#22240;&#20026;&#26412;&#39033;&#30446;&#20351;&#29992;&#30340;&#26159; project pages, &#25152;&#20197;&#25512;&#36865;&#21040; gh-pages &#20998;&#25903;</span>
<span class="org-yaml-tab">        </span><span class="org-variable-name">  target_branch</span>: gh-pages
</pre>
</div></li>
</ol>
</div>
</section>

<section id="outline-container-org11f965f" class="outline-2">
<h2 id="org11f965f">参考</h2>
<div class="outline-text-2" id="text-org11f965f">
<ol class="org-ol">
<li><a href="https://github.com/nukc/how-to-use-travis-ci">如何简单入门使用Travis-CI持续集成</a></li>

<li><a href="https://juejin.im/post/5c52c47ae51d453f45615c41">Travis CI持续集成GitHub个人博客</a></li>

<li><a href="https://docs.travis-ci.com/user/tutorial/">Travis-CI 官方入门教程</a></li>

<li><a href="https://help.github.com/en/articles/about-github-pages">GitHub Pages 官方介绍</a></li>
</ol>
</div>
</section>
</div>
<div id="postamble" class="status">
<footer class="footer">
  <a href="https://github.com/demokn/blog">
    <p>
      Built with <img id="i-orgmode" src="https://demokn.github.io/blog/assets/images/orgmode.svg"/> in <img id="i-emacs" src="https://demokn.github.io/blog/assets/images/emacs.svg"/>
      <span id="view-source-link"> View Source </span>
    </p>
  </a>
</footer>
</div>
<div id="disqus_thread"></div>
<script>
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://coral-reef.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>
</div>
</div>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-92899354-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-92899354-1');
</script>
<!-- Default Statcounter code -->
<script type="text/javascript">
var sc_project=11272126;
var sc_invisible=1;
var sc_security="cc0cb8d5";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="https://statcounter.com/" target="_blank"><img
class="statcounter"
src="https://c.statcounter.com/11272126/0/cc0cb8d5/1/"
alt="Web Analytics"></a></div></noscript>
<!-- End of Statcounter Code -->
</body>
</html>
