<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>使用 shadowsocks + frp 完全的访问内网资源</title>
<meta name="keywords" content="珊瑚礁上的程序员, shadowsocks, frp" />
<meta name="generator" content="Org Mode" />
<link rel="icon" href="https://demokn.github.io/blog/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://demokn.github.io/blog/assets/lib/twitter-bootstrap/4.4.1/bootstrap.min.css">
<link rel="stylesheet" href="https://demokn.github.io/blog/assets/lib/font-awesome/5.12.1/all.min.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=ZCOOL+KuaiLe|Amaranth|Handlee|Libre+Baskerville|Bree+Serif|Ubuntu+Mono|Pacifico&subset=latin,greek"/>
<link rel="stylesheet" href="https://demokn.github.io/blog/assets/css/site.css">
<link rel="stylesheet" href="https://demokn.github.io/blog/assets/css/highlight.css">
</head>
<body>
<div class="content-wrapper container">
<div class="row">
<div class="col-lg-8 col-md-10 mx-auto">

<div id="preamble" class="status">
<div class="banner">
  <a href="/" style="font-family: 'ZCOOL KuaiLe', cursive;"> 珊瑚礁上的程序员 </a>
</div>
<ul class="banner-links">
  <li><a href="https://demokn.github.io/blog/posts/archive.html"> Archive </a></li>
  <li><a href="https://demokn.github.io/blog/posts/rss.xml"> RSS </a></li>
  <li><a href="https://demokn.github.io/blog/about.html"> About </a></li>
</ul>
<hr>
</div>
<div id="article" class="content">
<header>
<h1 class="title">使用 shadowsocks + frp 完全的访问内网资源</h1>
<p class="subtitle" role="doc-subtitle">发布于 2022-10-27</p>
</header>
<section id="outline-container-org36c189a" class="outline-2">
<h2 id="org36c189a">需求</h2>
<div class="outline-text-2" id="text-org36c189a">
<p>
公司的很多资源都是限制内网访问的, 如 git 仓库, 内部网站等.
当然公司一般也会提供 VPN 给员工, 但最近公司提供的 VPN 不太好用.
就想着用放在公司的电脑做代理, 是不是就可以远程访问内部资源了.
</p>

<p>
更多的是出于学习的目的, 有了这次实践.
</p>
</div>
</section>

<section id="outline-container-org0448bcb" class="outline-2">
<h2 id="org0448bcb">要求</h2>
<div class="outline-text-2" id="text-org0448bcb">
<ul class="org-ul">
<li>一台有固定公网 IP 的云服务器 (我的是阿里云 ECS Ubuntu)</li>
<li>一台放在公司的个人电脑 (我的是 Macbook Pro)</li>
<li>一台放在外网(家里)的个人电脑 (我的是 Manjaro KDE)</li>
</ul>
</div>
</section>

<section id="outline-container-org447b7b0" class="outline-2">
<h2 id="org447b7b0">原理</h2>
<div class="outline-text-2" id="text-org447b7b0">
<p>
在 Mac 上开启 shadowsocks 服务, 借助 frp 将 Mac 上的 shadowsocks 服务端口映射到 ECS 的某个端口.
在 Manjaro 上开启 shandowsocks 客户端, 指定的 shandowsocks 服务器 IP 为 ECS 的公网 IP, 端口为 ECS 上的端口.
在 Manjaro 上浏览器借助 <code>SwitchyOmega</code> 走代理, ssh git 借助 <code>netcat</code> 走代理.
</p>
</div>
</section>

<section id="outline-container-org222240d" class="outline-2">
<h2 id="org222240d">步骤和配置</h2>
<div class="outline-text-2" id="text-org222240d">
</div>
<div id="outline-container-orgc59fd7a" class="outline-3">
<h3 id="orgc59fd7a">ECS 安装 frp 服务端</h3>
<div class="outline-text-3" id="text-orgc59fd7a">
<ol class="org-ol">
<li><p>
安装 frp
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">&#19979;&#36733; frp</span>
wget https://github.com/fatedier/frp/releases/download/v0.45.0/frp_0.45.0_linux_amd64.tar.gz
<span class="org-comment-delimiter"># </span><span class="org-comment">&#35299;&#21387; frp</span>
tar -xvf frp_0.45.0_linux_amd64.tar.gz
<span class="org-comment-delimiter"># </span><span class="org-comment">&#31227;&#21160;&#21629;&#20196;&#21644;&#37197;&#32622;</span>
<span class="org-builtin">cd</span> frp_0.45.0_linux_amd64
sudo mv frps /usr/bin/
sudo mkdir /etc/frp
sudo mv frps.ini /etc/frp
</pre>
</div></li>

<li><p>
frps.ini 配置
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span class="org-type">common</span>]
<span class="org-variable-name">bind_port</span> = 7000
<span class="org-variable-name">dashboard_port</span> = 7500
<span class="org-variable-name">token</span> = YOUR_TOKEN
<span class="org-variable-name">dashboard_user</span> = YOUR_USER
<span class="org-variable-name">dashboard_pwd</span> = YOUR_PWD
</pre>
</div></li>

<li><p>
启动 frp 服务
</p>
<div class="org-src-container">
<pre class="src src-sh">nohup frps -c /etc/frp/frps.ini &gt;/var/log/frps.log 2&gt;&amp;1 &amp;
</pre>
</div></li>

<li>记得在 ECS 管理后台开启相应的端口访问</li>
</ol>
</div>
</div>

<div id="outline-container-orgc007a3c" class="outline-3">
<h3 id="orgc007a3c">Mac 安装 shadowsocks 服务端和 frp 客户端</h3>
<div class="outline-text-3" id="text-orgc007a3c">
<ol class="org-ol">
<li><p>
使用 <code>brew</code> 安装
</p>
<div class="org-src-container">
<pre class="src src-sh">brew install frpc shadowsocks-libev
</pre>
</div></li>

<li><p>
frpc.ini 配置
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span class="org-type">common</span>]
<span class="org-variable-name">server_addr</span> = YOUR_ECS_IP
<span class="org-variable-name">server_port</span> = 7000
<span class="org-variable-name">token</span> = YOUR_TOKEN

[<span class="org-type">mac-sss</span>]
<span class="org-variable-name">type</span> = tcp
<span class="org-variable-name">local_ip</span> = 127.0.0.1
<span class="org-variable-name">local_port</span> = 8388
<span class="org-variable-name">remote_port</span> = 2388
</pre>
</div></li>

<li><p>
shadowsocks 配置
</p>
<div class="org-src-container">
<pre class="src src-javascript">{
  <span class="org-string">"server"</span>:[<span class="org-string">"::0"</span>,<span class="org-string">"0.0.0.0"</span>],
  <span class="org-string">"server_port"</span>:8388,
  <span class="org-string">"method"</span>:<span class="org-string">"chacha20-ietf-poly1305"</span>,
  <span class="org-string">"password"</span>:<span class="org-string">"YOUR_PASSWORD"</span>,
  <span class="org-string">"timeout"</span>:600,
  <span class="org-string">"mode"</span>:<span class="org-string">"tcp_only"</span>,
  <span class="org-string">"fast_open"</span>:<span class="org-constant">false</span>
}
</pre>
</div></li>

<li><p>
启动 shadowsocks 和 frp
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">&#24320;&#21551; shadowsocks &#26381;&#21153;&#31471;</span>
ss-server -c /usr/local/etc/shadowsocks-libev-server.json
<span class="org-comment-delimiter"># </span><span class="org-comment">&#24320;&#21551; frp &#23458;&#25143;&#31471;</span>
frpc -c /usr/local/etc/frp/frpc.ini
</pre>
</div></li>
</ol>
</div>
</div>

<div id="outline-container-orgc16aa7f" class="outline-3">
<h3 id="orgc16aa7f">Manjaro 安装 shadowsocks 客户端</h3>
<div class="outline-text-3" id="text-orgc16aa7f">
<ol class="org-ol">
<li><p>
安装 shadowsocks 和 netcat
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo pacman -S shadowsocks-libev openbsd-netcat
</pre>
</div></li>

<li><p>
启动 shadowsocks
</p>
<div class="org-src-container">
<pre class="src src-shell">ss-local -s ECS_IP -p 2288 -l 1088 -m chacha20-ietf-poly1305 -k YOUR_PASSWORD
</pre>
</div></li>

<li><p>
ssh git 代理配置
</p>
<div class="org-src-container">
<pre class="src src-conf">Host your_company.com
    Hostname your_company.com
    ProxyCommand nc -x 127.0.0.1:1080 %h %p
</pre>
</div></li>

<li>SwitchyOmega 配置
不再赘述</li>
</ol>
</div>
</div>

<div id="outline-container-org2fabc7d" class="outline-3">
<h3 id="org2fabc7d">参考</h3>
<div class="outline-text-3" id="text-org2fabc7d">
<ul class="org-ul">
<li><a href="https://oneforalone.github.io/misc/frp.html">内网穿透 frp 配置</a></li>
<li><a href="https://blog.ikuamike.io/posts/2021/netcat/">Netcat - All you need to know</a></li>
<li><a href="https://superuser.com/questions/1233614/what-is-the-difference-between-shadowsocks-and-openvpn">What is the difference between shadowsocks and openvpn?</a></li>
</ul>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
<footer class="footer">
  <a href="https://github.com/demokn/blog">
    <p>
      Built with <img id="i-orgmode" src="https://demokn.github.io/blog/assets/images/orgmode.svg"/> in <img id="i-emacs" src="https://demokn.github.io/blog/assets/images/emacs.svg"/>
      <span id="view-source-link"> View Source </span>
    </p>
  </a>
</footer>
</div>
<div id="disqus_thread"></div>
<script>
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://coral-reef.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>
</div>
</div>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-92899354-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-92899354-1');
</script>
<!-- Default Statcounter code -->
<script type="text/javascript">
var sc_project=11272126;
var sc_invisible=1;
var sc_security="cc0cb8d5";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="https://statcounter.com/" target="_blank"><img
class="statcounter"
src="https://c.statcounter.com/11272126/0/cc0cb8d5/1/"
alt="Web Analytics"></a></div></noscript>
<!-- End of Statcounter Code -->
</body>
</html>
