<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>使用 git-hooks + phpcs + composer-scripts 践行PHP编码规范</title>
<meta name="keywords" content="珊瑚礁上的程序员, 编码规范, Git Hooks, .pre-commit, PHP_CodeSniffer, Composer Scripts" />
<meta name="generator" content="Org Mode" />
<link rel="icon" href="https://demokn.github.io/blog/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://demokn.github.io/blog/assets/lib/twitter-bootstrap/4.4.1/bootstrap.min.css">
<link rel="stylesheet" href="https://demokn.github.io/blog/assets/lib/font-awesome/5.12.1/all.min.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=ZCOOL+KuaiLe|Amaranth|Handlee|Libre+Baskerville|Bree+Serif|Ubuntu+Mono|Pacifico&subset=latin,greek"/>
<link rel="stylesheet" href="https://demokn.github.io/blog/assets/css/site.css">
<link rel="stylesheet" href="https://demokn.github.io/blog/assets/css/highlight.css">
</head>
<body>
<div class="content-wrapper container">
<div class="row">
<div class="col-lg-8 col-md-10 mx-auto">

<div id="preamble" class="status">
<div class="banner">
  <a href="/" style="font-family: 'ZCOOL KuaiLe', cursive;"> 珊瑚礁上的程序员 </a>
</div>
<ul class="banner-links">
  <li><a href="https://demokn.github.io/blog/posts/archive.html"> Archive </a></li>
  <li><a href="https://demokn.github.io/blog/posts/rss.xml"> RSS </a></li>
  <li><a href="https://demokn.github.io/blog/about.html"> About </a></li>
</ul>
<hr>
</div>
<div id="article" class="content">
<header>
<h1 class="title">使用 git-hooks + phpcs + composer-scripts 践行PHP编码规范</h1>
<p class="subtitle" role="doc-subtitle">发布于 2019-07-22</p>
</header>
<section id="outline-container-org2c4e1b4" class="outline-2">
<h2 id="org2c4e1b4">背景</h2>
<div class="outline-text-2" id="text-org2c4e1b4">
<p>
关于代码规范的重要性，诸如促进团队合作、降低维护成本、有助于代码审查、有助于自身成长等，这里就不详细赘述了，直接进入正题。
</p>
</div>
</section>

<section id="outline-container-orgb99f566" class="outline-2">
<h2 id="orgb99f566">PHP编码规范</h2>
<div class="outline-text-2" id="text-orgb99f566">
<p>
当前主流的PHP编码规范是由 <a href="https://www.php-fig.org/">PHP FIG</a> 组织制定的 <a href="https://www.php-fig.org/psr/">PSR</a> 系列规范，如 <code>PSR-1</code> , <code>PSR-2</code> , <code>PSR-4</code> 。
当然还是有其他一些规范的存在，如 <a href="https://pear.php.net/manual/en/standards.php">PEAR规范</a> 和 <a href="https://symfony.com/doc/current/contributing/code/standards.html">Symfony规范</a>。我们使用的主要是 <code>PSR-2</code> 规范。
</p>

<p>
用于检查和修复代码规范的工具主要有 <a href="https://github.com/squizlabs/PHP_CodeSniffer">PHP_CodeSniffer</a> 和 <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer">PHP-CS-Fixer</a>。
如果你还想了解这两个工具的差异，可以看下这个 <a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/issues/3459">ISSUE</a>。我们本次使用的是 <code>PHP_CodeSniffer</code> 。
</p>
</div>
</section>

<section id="outline-container-orgd90dbff" class="outline-2">
<h2 id="orgd90dbff">Git钩子</h2>
<div class="outline-text-2" id="text-orgd90dbff">
<p>
和其它版本控制系统一样，Git 能在特定的重要动作发生时触发自定义脚本。
有两组这样的钩子：客户端的和服务器端的。
客户端钩子由诸如提交和合并这样的操作所调用，而服务器端钩子作用于诸如接收被推送的提交这样的联网操作。
钩子都被存储在 Git 目录下的 hooks 子目录中。 也即绝大部分项目中的 <code>.git/hooks</code> 。 
查看一下你项目中的该目录, 就会看到诸如 <code>pre-commit.sample</code>, <code>pre-push.sample</code>, <code>pre-receive.sample</code> 等文件。
要使用他们，只需要把 <code>.sample</code> 后缀去掉，然后编辑自己的代码即可。
这里我们用的是 <code>pre-commit</code> 钩子，即在键入提交信息 <code>git commit</code> 前运行。
它一般用于检查即将提交的快照，例如，检查是否有所遗漏，确保测试运行，以及核查代码。
如果该钩子以非零值退出，Git 将放弃此次提交，不过也可以用 <code>git commit --no-verify</code> 来绕过这个环节。
</p>
</div>
</section>

<section id="outline-container-org235eb3b" class="outline-2">
<h2 id="org235eb3b">Show me the code</h2>
<div class="outline-text-2" id="text-org235eb3b">
<p>
废话不多说，直接上代码吧。 以下为 <code>.git/hooks/pre-commit</code> 的代码：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">sh</span>

<span class="org-variable-name">PROJECT</span>=<span class="org-sh-quoted-exec">`php -r "echo dirname(dirname(dirname(realpath('$0'))));"`</span>
<span class="org-variable-name">STAGED_FILES_CMD</span>=<span class="org-sh-quoted-exec">`git diff --cached --name-only --diff-filter=ACMR HEAD | grep \\\\.php`</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Determine if a file list is passed</span>
<span class="org-keyword">if</span> [ <span class="org-string">"$#"</span> -eq 1 ]
<span class="org-keyword">then</span>
    <span class="org-variable-name">oIFS</span>=$<span class="org-variable-name">IFS</span>
    <span class="org-variable-name">IFS</span>=<span class="org-string">'</span>
<span class="org-string">    '</span>
    <span class="org-variable-name">SFILES</span>=<span class="org-string">"$1"</span>
    <span class="org-variable-name">IFS</span>=$<span class="org-variable-name">oIFS</span>
<span class="org-keyword">fi</span>
<span class="org-variable-name">SFILES</span>=${<span class="org-variable-name">SFILES</span>:-$<span class="org-variable-name">STAGED_FILES_CMD</span>}

<span class="org-builtin">echo</span> <span class="org-string">"Checking PHP Lint..."</span>
<span class="org-keyword">for</span> FILE<span class="org-keyword"> in</span> $<span class="org-variable-name">SFILES</span>
<span class="org-keyword">do</span>
    php -l -d <span class="org-variable-name">display_errors</span>=0 $<span class="org-variable-name">PROJECT</span>/$<span class="org-variable-name">FILE</span>
    <span class="org-keyword">if</span> [ $<span class="org-variable-name">?</span> != 0 ]
    <span class="org-keyword">then</span>
        <span class="org-builtin">echo</span> <span class="org-string">"Fix the error before commit."</span>
        <span class="org-keyword">exit</span> 1
    <span class="org-keyword">fi</span>
    <span class="org-variable-name">FILES</span>=<span class="org-string">"$FILES $PROJECT/$FILE"</span>
<span class="org-keyword">done</span>

<span class="org-keyword">if</span> [ <span class="org-string">"$FILES"</span> != <span class="org-string">""</span> ]
<span class="org-keyword">then</span>
    <span class="org-builtin">echo</span> <span class="org-string">"Running Code Sniffer..."</span>
    ./vendor/bin/phpcs $<span class="org-variable-name">FILES</span>
    <span class="org-keyword">if</span> [ $<span class="org-variable-name">?</span> != 0 ]
    <span class="org-keyword">then</span>
        <span class="org-builtin">echo</span> <span class="org-string">"Fix the error before commit!"</span>
        <span class="org-builtin">echo</span> <span class="org-string">"Run"</span>
        <span class="org-builtin">echo</span> <span class="org-string">"  ./vendor/bin/phpcbf $FILES"</span>
        <span class="org-builtin">echo</span> <span class="org-string">"for automatic fix or fix it manually."</span>
        <span class="org-keyword">exit</span> 1
    <span class="org-keyword">fi</span>
<span class="org-keyword">fi</span>

<span class="org-keyword">exit</span> $<span class="org-variable-name">?</span>
</pre>
</div>

<p>
通过代码也能看出，我们直接使用了当前项目中的 <code>./vendor/bin/phpcs</code>, 即需要我们在项目中加载 <code>PHP_CodeSniffer</code> 包。
执行 <code>composer require squizlabs/php_codesniffer --dev</code> 即可。
另外，在hook中我们也没有具体指明phpcs要使用哪种规范标准，
因为这更多是取决于我们自己的项目，具体的规则定义在项目根目录下的 <code>phpcs.xml</code> 配置文件中即可。
如果你想参考的话，<a href="https://github.com/demokn/phpcs-pre-commit-hook/blob/master/phpcs.xml-yii2">这里</a> 是一个我们使用的关于 <code>yii2</code> 的规则。
</p>
</div>
</section>

<section id="outline-container-org7c8daf4" class="outline-2">
<h2 id="org7c8daf4">安装的Git钩子无法加入版本库, 每个成员，每个环境都要重复装一遍?</h2>
<div class="outline-text-2" id="text-org7c8daf4">
<p>
<code>.git</code> 目录下的文件无法加入版本库，这就导致了团队成员中的每个人都要手动安装一次钩子，或者你的多套环境也要重复安装钩子，这当然是很不方便的。
为了解决这个问题，我们可以利用 <code>composer</code> 的钩子来自动完成安装git钩子的过程。
</p>

<p>
Composer 在执行的过程中会触发一些事件，我们可以通过监控这些事件来自动触发一些脚本的执行。
就自动安装git钩子这个需求，我们可以使用 <code>post-install-cmd</code> 钩子，即当项目里有 <code>composer.lock</code> 文件的情况下调用 install 命令后执行安装脚本。
安装脚本就用最简单的单行PHP脚本即可。
同样，直接上代码：
</p>

<ol class="org-ol">
<li>将git的pre-commit钩子脚本放在项目根目录下，命名为 <code>.git-pre-commit</code> , 并加入版本库;</li>

<li><p>
编辑项目中的 <code>composer.json</code> 文件：
</p>

<div class="org-src-container">
<pre class="src src-json">{
    <span class="org-keyword">"scripts"</span>: {
        <span class="org-keyword">"post-install-cmd"</span>: [
            <span class="org-string">"php -r \"is_dir('.git/hooks') &amp;&amp; !is_file('.git/hooks/pre-commit') &amp;&amp; copy('.git-pre-commit', '.git/hooks/pre-commit') &amp;&amp; chmod('.git/hooks/pre-commit', 0755);\""</span>
        ]
    }
}
</pre>
</div>

<p>
加入如上代码后，当执行 <code>composer install</code> 后，会自动执行那行php代码，
即简单的将 <code>.git-pre-commit</code> 钩子脚本复制到 <code>.git/hooks/pre-commit</code> 。
</p>

<p>
当然了，借助 <code>composer</code> 的脚本特性，你也可以继续定义其他的一些常用命令，比如：执行编码规范检查、执行编码规范修复等。
代码简单如下：
</p>

<div class="org-src-container">
<pre class="src src-json">{
    <span class="org-keyword">"scripts"</span>: {
        <span class="org-keyword">"cs"</span>: <span class="org-string">"phpcs ."</span>,
        <span class="org-keyword">"cbf"</span>: <span class="org-string">"phpcbf ."</span>
    }
}
</pre>
</div>

<p>
定义好之后，在项目根目录下执行 <code>composer cs</code> 即可对全项目进行编码规范检查，执行 <code>composer cbf</code> 即可对全项目进行编码规范修复。
</p></li>
</ol>
</div>
</section>

<section id="outline-container-org625ad68" class="outline-2">
<h2 id="org625ad68">结束语</h2>
<div class="outline-text-2" id="text-org625ad68">
<p>
我们日常用到的一些工具类确实都很强大，只是平时我们都只满足于最简单的日常使用。也许多看一眼文档，就能学习一些更高阶的用法。
希望自己能对日常使用的一些工具能较深入的了解学习一下，也许学习会花一些时间，但是更能为以后的开发节约不少时间，避免重复劳动。
</p>
</div>
</section>

<section id="outline-container-orga599f8b" class="outline-2">
<h2 id="orga599f8b">参考</h2>
<div class="outline-text-2" id="text-orga599f8b">
<ol class="org-ol">
<li><a href="http://psr.phphub.org/">PHP编码规范</a></li>

<li><a href="https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90">Git钩子</a></li>

<li><a href="https://learnku.com/docs/composer/2018/scripts/2095">Composer事件和自定义脚本</a></li>

<li><a href="https://phptherightway.com/">PHP The Right Way</a> <a href="http://laravel-china.github.io/php-the-right-way/">中文版</a></li>
</ol>
</div>
</section>
</div>
<div id="postamble" class="status">
<footer class="footer">
  <a href="https://github.com/demokn/blog">
    <p>
      Built with <img id="i-orgmode" src="https://demokn.github.io/blog/assets/images/orgmode.svg"/> in <img id="i-emacs" src="https://demokn.github.io/blog/assets/images/emacs.svg"/>
      <span id="view-source-link"> View Source </span>
    </p>
  </a>
</footer>
</div>
<div id="disqus_thread"></div>
<script>
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://coral-reef.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>
</div>
</div>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-92899354-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-92899354-1');
</script>
<!-- Default Statcounter code -->
<script type="text/javascript">
var sc_project=11272126;
var sc_invisible=1;
var sc_security="cc0cb8d5";
</script>
<script type="text/javascript"
src="https://www.statcounter.com/counter/counter.js"
async></script>
<noscript><div class="statcounter"><a title="Web Analytics"
href="https://statcounter.com/" target="_blank"><img
class="statcounter"
src="https://c.statcounter.com/11272126/0/cc0cb8d5/1/"
alt="Web Analytics"></a></div></noscript>
<!-- End of Statcounter Code -->
</body>
</html>
